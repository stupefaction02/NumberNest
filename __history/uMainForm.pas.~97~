unit uMainForm;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.ComCtrls, uArrayHelper,
  uHeapSort, uShellSort, uBaseLogger, uBaseLoggerProvider, Vcl.ExtCtrls, System.TimeSpan, System.Math, System.Diagnostics;

type
  TForm1 = class(TForm)
    ShellSortButton: TButton;
    SetLengthTextBox: TEdit;
    Label1: TLabel;
    HeapSortButton: TButton;
    GenerateSetButton: TButton;
    SetPanel: TRichEdit;
    Label2: TLabel;
    Label3: TLabel;
    LogsRichEdit: TRichEdit;
    SortingVisualiser: TPaintBox;

    procedure GenerateSetButtonClick(Sender: TObject);
    procedure ShellSortButtonClick(Sender: TObject);
    procedure HeapSortButtonClick(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure SortingVisualiserPaint(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);


  private
    TargetSet: TArray<Integer>;
    ShellSort1: TShellSort;
    HeapSort1: THeapSort;
    Logger: TBaseLogger;
    LargestSetElement: Integer;

    procedure OnSortIteration(const Param: Integer);

    procedure EnableUI(IsEnable: BOOLEAN);


  public
    { Public declarations }
  end;

var
  Form1: TForm1;

implementation

{$R *.dfm}

procedure TForm1.GenerateSetButtonClick(Sender: TObject);
var
  SetLength: Integer;
begin
  EnableUI(false);

  SetLength := StrToIntDef(SetLengthTextBox.Text, 0);

  TargetSet := nil;
  TargetSet := TArrayHelper.CreateRandom(SetLength);

  Logger.Log( Format('Set of %d elements was generated', [ SetLength ]) );

  LargestSetElement := MaxIntValue( TargetSet );

  Form1.SetPanel.Text := TArrayHelper.ArrayTostring(TargetSet);

  SortingVisualiser.Invalidate;

  EnableUI(true);
end;

procedure TForm1.HeapSortButtonClick(Sender: TObject);
var
  Stopwatch: TStopwatch;
  Elapsed: TTimeSpan;

begin
   EnableUI(false);

   Stopwatch := TStopwatch.StartNew;

   TThread.CreateAnonymousThread(procedure
      begin
         ShellSort1.Sort(TargetSet);

         Elapsed := Stopwatch.Elapsed;
         Logger.Log( Format('Sorted %d elements, Took %g ms', [ Length(TargetSet), Elapsed.TotalSeconds ]));
      end
   ).Start;

   Elapsed := Stopwatch.Elapsed;

   Form1.SetPanel.Text := TArrayHelper.ArrayTostring(TargetSet);

   Logger.Log( Format('Sorted %d elements, Took %d ms', [ Length(TargetSet), Elapsed.TotalSeconds ]));

   EnableUI(true);
end;

procedure TForm1.SortingVisualiserPaint(Sender: TObject);
var
  X, Y, I, Width, Height: Integer;
begin

  if ( Length(TargetSet) < 1 ) then Exit();
      SetRoundMode(rmTruncate);
  Width := Round( SortingVisualiser.Width / Length(TargetSet) );
  Height := SortingVisualiser.Height;

  for I := 0 to Length(TargetSet) - 1 do
    begin
      X := I * Width;
      Y := Height - (TargetSet[i] * Round(Height / LargestSetElement));
      SortingVisualiser.Canvas.Rectangle(X, Y, X + Width, Height);
    end;

end;

procedure TForm1.ShellSortButtonClick(Sender: TObject);
var
  Stopwatch: TStopwatch;
  Elapsed: TTimeSpan;

begin
   EnableUI(false);

   Stopwatch := TStopwatch.StartNew;

   TThread.CreateAnonymousThread(procedure
      begin


         ShellSort1.Sort(TargetSet);

         EnableUI(true);

         Elapsed := Stopwatch.Elapsed;
         Logger.Log( Format('Sorted %d elements, Took %g ms', [ Length(TargetSet), Elapsed.TotalSeconds ]));
      end
   ).Start;
end;

procedure TForm1.EnableUI(IsEnable: BOOLEAN);
begin
  SetLengthTextBox.Enabled := IsEnable;
  ShellSortButton.Enabled := IsEnable;
  HeapSortButton.Enabled := IsEnable;
  GenerateSetButton.Enabled := IsEnable;
end;

procedure TForm1.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  Logger.Log('Closing.');

  Logger.Free;
  TargetSet := nil;
  ShellSort1.Free;
  HeapSort1.Free;
end;

procedure TForm1.FormCreate(Sender: TObject);
begin
  ShellSort1 := TShellSort.Create;
  HeapSort1 := THeapSort.Create;

  ShellSort1.OnSortIteration := OnSortIteration;
  HeapSort1.OnSortIteration := OnSortIteration;

  Form1.DoubleBuffered := true;

  SortingVisualiser.Canvas.Brush.Color := clBlack;

  // TODO: Make with factory
  Logger := TBaseLogger.Create('Main');

  Logger.AddProvider( TListBoxLogProvider.Create(LogsRichEdit) );
end;

procedure TForm1.OnSortIteration(const Param: Integer);
begin
   // Post execution to UI thread
   TThread.Synchronize(nil,
     procedure
       begin
        Form1.SetPanel.Text := TArrayHelper.ArrayTostring(TargetSet);
        SortingVisualiser.Invalidate;
       end
   );

   Sleep(100);
end;

end.
